name: Generate PDF

# n8n will commit the tex file to the repository
# workflow gets triggered
# pdf is generated and saved with the same name in the generated branch

on:
  push:
    branches:
      - 'n8n'  # Triggers on push to any branch

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Tectonic
        run: |
          curl --proto '=https' --tlsv1.2 -fsSL https://drop-sh.fullyjustified.net | sh

      - name: Find changed .tex files and build PDFs
        id: process_tex
        run: |
          # Get list of .tex files that were changed/added in this commit
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            TEX_FILES=$(git diff --name-only --diff-filter=ACMR ${{ github.event.before }} ${{ github.sha }} | grep '\.tex$' || true)
          else
            # First commit - check all .tex files in HEAD
            TEX_FILES=$(git ls-tree -r --name-only HEAD | grep '\.tex$' || true)
          fi
          
          if [ -z "$TEX_FILES" ]; then
            echo "No .tex files found in this commit"
            exit 1
          fi
          
          echo "Found .tex files:"
          echo "$TEX_FILES"
          
          # Process each .tex file and track generated PDFs
          > pdf_files.txt  # Create/clear the file
          while IFS= read -r tex_file; do
            if [ -n "$tex_file" ] && [ -f "$tex_file" ]; then
              echo "Processing $tex_file..."
              ./tectonic "$tex_file"
              
              # Get the PDF filename (replace .tex with .pdf)
              pdf_file="${tex_file%.tex}.pdf"
              
              if [ ! -f "$pdf_file" ]; then
                echo "Error: $pdf_file was not created from $tex_file"
                exit 1
              fi
              
              echo "Successfully generated $pdf_file"
              echo "$pdf_file" >> pdf_files.txt
            fi
          done <<< "$TEX_FILES"

      - name: Commit and push PDFs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "punase.ronak99@gmail.com"
          git config --local user.name "Ronak99"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          
          # Store generated PDFs in a temporary directory
          mkdir -p /tmp/generated_pdfs
          if [ -f pdf_files.txt ]; then
            # Store pdf_files.txt for later use
            cp pdf_files.txt /tmp/pdf_files.txt
            while IFS= read -r pdf_file; do
              if [ -n "$pdf_file" ] && [ -f "$pdf_file" ]; then
                cp "$pdf_file" "/tmp/generated_pdfs/$(basename "$pdf_file")"
                echo "Stored $pdf_file"
              fi
            done < pdf_files.txt
          fi
          
          # Fetch all branches
          git fetch origin
          
          # Checkout or create the generated branch
          if git show-ref --verify --quiet refs/remotes/origin/generated; then
            git checkout -b generated origin/generated 2>/dev/null || git checkout generated
            git pull --rebase origin generated || true
          else
            git checkout -b generated
          fi
          
          # Copy stored PDFs to the generated branch
          if [ -f pdf_files.txt ]; then
            while IFS= read -r pdf_file; do
              if [ -n "$pdf_file" ]; then
                pdf_basename=$(basename "$pdf_file")
                if [ -f "/tmp/generated_pdfs/$pdf_basename" ]; then
                  cp "/tmp/generated_pdfs/$pdf_basename" "$pdf_file"
                  git add "$pdf_file"
                  echo "Added $pdf_file to staging"
                fi
              fi
            done < pdf_files.txt
          fi
          
          # Commit if there are changes
          if ! git diff --staged --quiet; then
            COMMIT_MSG="Auto-generate PDFs from .tex files [skip ci]"
            git commit -m "$COMMIT_MSG"
            COMMIT_SHA=$(git rev-parse HEAD)
            git push origin generated
            
            # Store commit SHA for webhook
            echo "COMMIT_SHA=${COMMIT_SHA}" >> $GITHUB_ENV
            echo "PDFS_GENERATED=true" >> $GITHUB_ENV
          else
            echo "No PDF files to commit"
            exit 0
          fi

      - name: Trigger webhook for generated PDFs
        if: success()
        env:
          COMMIT_SHA: ${{ env.COMMIT_SHA }}
        run: |
          WEBHOOK_URL="https://aeravath.app.n8n.cloud/webhook-test/b88c72d3-7fc3-43ea-ba66-048ab0fb405b"
          
          # Restore pdf_files.txt from temporary storage
          if [ -f /tmp/pdf_files.txt ]; then
            cp /tmp/pdf_files.txt pdf_files.txt
          fi
          
          if [ -f pdf_files.txt ]; then
            while IFS= read -r pdf_file; do
              if [ -n "$pdf_file" ]; then
                # Construct GitHub raw URL for the PDF file
                PDF_URL="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/generated/${pdf_file}"
                
                echo "Triggering webhook for $pdf_file"
                echo "PDF URL: $PDF_URL"
                
                # Send webhook with PDF URL
                curl -X POST "$WEBHOOK_URL" \
                  -H "Content-Type: application/json" \
                  -d "{\"pdf_url\": \"${PDF_URL}\", \"pdf_file\": \"${pdf_file}\", \"repository\": \"${GITHUB_REPOSITORY}\", \"branch\": \"generated\", \"commit\": \"${COMMIT_SHA}\"}"
              fi
            done < pdf_files.txt
          fi
