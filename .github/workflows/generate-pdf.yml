name: Generate PDF

# n8n will commit the tex file to the repository
# workflow gets triggered
# pdf is generated and saved with the same name in the generated branch

on:
  push:
    branches:
      - 'n8n'  # Triggers on push to any branch

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Tectonic
        run: |
          curl --proto '=https' --tlsv1.2 -fsSL https://drop-sh.fullyjustified.net | sh

      - name: Find changed .tex files and build PDFs
        id: process_tex
        run: |
          set -e  # Exit on error
          
          # Get list of .tex files that were changed/added in this commit
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            TEX_FILES=$(git diff --name-only --diff-filter=ACMR ${{ github.event.before }} ${{ github.sha }} | grep '\.tex$' || true)
          else
            # First commit - check all .tex files in HEAD
            TEX_FILES=$(git ls-tree -r --name-only HEAD | grep '\.tex$' || true)
          fi
          
          if [ -z "$TEX_FILES" ]; then
            ERROR_MSG="No .tex files found in this commit"
            echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
            echo "$ERROR_MSG"
            exit 1
          fi
          
          echo "Found .tex files:"
          echo "$TEX_FILES"
          
          # Process each .tex file and track generated PDFs
          > pdf_files.txt  # Create/clear the file
          while IFS= read -r tex_file; do
            if [ -n "$tex_file" ] && [ -f "$tex_file" ]; then
              echo "Processing $tex_file..."
              
              # Run tectonic and capture errors
              if ! ./tectonic "$tex_file" 2>&1; then
                ERROR_MSG="Failed to process $tex_file with tectonic"
                echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
                echo "$ERROR_MSG"
                exit 1
              fi
              
              # Get the PDF filename (replace .tex with .pdf)
              pdf_file="${tex_file%.tex}.pdf"
              
              if [ ! -f "$pdf_file" ]; then
                ERROR_MSG="PDF file $pdf_file was not created from $tex_file"
                echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
                echo "$ERROR_MSG"
                exit 1
              fi
              
              echo "Successfully generated $pdf_file"
              echo "$pdf_file" >> pdf_files.txt
            fi
          done <<< "$TEX_FILES"
          
          echo "PDFS_GENERATED=true" >> $GITHUB_ENV

      - name: Commit and push PDFs
        id: commit_push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e  # Exit on error
          
          git config --local user.email "punase.ronak99@gmail.com"
          git config --local user.name "Ronak99"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          
          # Store generated PDFs in a temporary directory
          mkdir -p /tmp/generated_pdfs
          if [ -f pdf_files.txt ]; then
            # Store pdf_files.txt for later use
            cp pdf_files.txt /tmp/pdf_files.txt
            while IFS= read -r pdf_file; do
              if [ -n "$pdf_file" ] && [ -f "$pdf_file" ]; then
                cp "$pdf_file" "/tmp/generated_pdfs/$(basename "$pdf_file")"
                echo "Stored $pdf_file"
              fi
            done < pdf_files.txt
          else
            ERROR_MSG="No pdf_files.txt found - PDFs may not have been generated"
            echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
            echo "$ERROR_MSG"
            exit 1
          fi
          
          # Fetch all branches
          if ! git fetch origin; then
            ERROR_MSG="Failed to fetch from origin"
            echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
            echo "$ERROR_MSG"
            exit 1
          fi
          
          # Checkout or create the generated branch
          if git show-ref --verify --quiet refs/remotes/origin/generated; then
            git checkout -b generated origin/generated 2>/dev/null || git checkout generated
            if ! git pull --rebase origin generated; then
              ERROR_MSG="Failed to pull/rebase generated branch"
              echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
              echo "$ERROR_MSG"
              exit 1
            fi
          else
            git checkout -b generated
          fi
          
          # Copy stored PDFs to the generated branch
          if [ -f /tmp/pdf_files.txt ]; then
            cp /tmp/pdf_files.txt pdf_files.txt
            while IFS= read -r pdf_file; do
              if [ -n "$pdf_file" ]; then
                pdf_basename=$(basename "$pdf_file")
                if [ -f "/tmp/generated_pdfs/$pdf_basename" ]; then
                  cp "/tmp/generated_pdfs/$pdf_basename" "$pdf_file"
                  git add "$pdf_file"
                  echo "Added $pdf_file to staging"
                else
                  ERROR_MSG="PDF file /tmp/generated_pdfs/$pdf_basename not found"
                  echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
                  echo "$ERROR_MSG"
                  exit 1
                fi
              fi
            done < pdf_files.txt
          fi
          
          # Commit if there are changes
          if ! git diff --staged --quiet; then
            COMMIT_MSG="Auto-generate PDFs from .tex files [skip ci]"
            if ! git commit -m "$COMMIT_MSG"; then
              ERROR_MSG="Failed to commit PDF files"
              echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
              echo "$ERROR_MSG"
              exit 1
            fi
            COMMIT_SHA=$(git rev-parse HEAD)
            if ! git push origin generated; then
              ERROR_MSG="Failed to push to generated branch"
              echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
              echo "$ERROR_MSG"
              exit 1
            fi
            
            # Store commit SHA for webhook
            echo "COMMIT_SHA=${COMMIT_SHA}" >> $GITHUB_ENV
            echo "PDFS_COMMITTED=true" >> $GITHUB_ENV
          else
            ERROR_MSG="No PDF files to commit - staging area is empty"
            echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
            echo "$ERROR_MSG"
            exit 1
          fi

      - name: Trigger webhook for generated PDFs
        if: success() && env.PDFS_COMMITTED == 'true'
        env:
          COMMIT_SHA: ${{ env.COMMIT_SHA }}
        run: |
          WEBHOOK_URL="https://aeravath.app.n8n.cloud/webhook-test/b88c72d3-7fc3-43ea-ba66-048ab0fb405b"
          
          # Restore pdf_files.txt from temporary storage
          if [ -f /tmp/pdf_files.txt ]; then
            cp /tmp/pdf_files.txt pdf_files.txt
          fi
          
          if [ -f pdf_files.txt ]; then
            while IFS= read -r pdf_file; do
              if [ -n "$pdf_file" ]; then
                # Construct GitHub raw URL for the PDF file
                PDF_URL="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/generated/${pdf_file}"
                
                echo "Triggering webhook for $pdf_file"
                echo "PDF URL: $PDF_URL"
                
                # Send webhook with PDF URL and handle errors
                # Escape JSON special characters in variables
                PDF_URL_ESC=$(printf '%s' "$PDF_URL" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
                PDF_FILE_ESC=$(printf '%s' "$pdf_file" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
                REPO_ESC=$(printf '%s' "$GITHUB_REPOSITORY" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
                COMMIT_ESC=$(printf '%s' "$COMMIT_SHA" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
                
                # Build JSON payload using printf to avoid heredoc issues
                WEBHOOK_PAYLOAD=$(printf '{"status":"success","pdf_url":"%s","pdf_file":"%s","repository":"%s","branch":"generated","commit":"%s"}' \
                  "$PDF_URL_ESC" "$PDF_FILE_ESC" "$REPO_ESC" "$COMMIT_ESC")
                
                if ! curl -X POST "$WEBHOOK_URL" \
                  -H "Content-Type: application/json" \
                  -d "$WEBHOOK_PAYLOAD" \
                  -f -s -w "\nHTTP Status: %{http_code}\n" -o /dev/null; then
                  echo "ERROR_MSG=Webhook call failed for $pdf_file" >> $GITHUB_ENV
                  echo "WEBHOOK_FAILED=true" >> $GITHUB_ENV
                  echo "Warning: Failed to send success webhook for $pdf_file"
                fi
              fi
            done < pdf_files.txt
          fi

      - name: Send webhook error notification
        if: success() && env.WEBHOOK_FAILED == 'true'
        env:
          ERROR_MSG: ${{ env.ERROR_MSG }}
        run: |
          WEBHOOK_URL="https://aeravath.app.n8n.cloud/webhook-test/b88c72d3-7fc3-43ea-ba66-048ab0fb405b"
          
          ERROR_MESSAGE="${ERROR_MSG:-Webhook notification failed after successful PDF generation}"
          
          # Escape JSON strings
          escape_json() {
            echo "$1" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed 's/$/\\n/' | tr -d '\n' | sed 's/\\n$//'
          }
          
          ERROR_MSG_ESC=$(escape_json "$ERROR_MESSAGE")
          REPO_ESC=$(escape_json "${GITHUB_REPOSITORY}")
          BRANCH_ESC=$(escape_json "${GITHUB_REF#refs/heads/}")
          COMMIT_ESC=$(escape_json "${GITHUB_SHA}")
          RUN_ID_ESC=$(escape_json "${GITHUB_RUN_ID}")
          
          # Build JSON payload using printf
          JSON_PAYLOAD=$(printf '{"status":"error","error_message":"%s","error_type":"webhook_failure","repository":"%s","branch":"%s","commit":"%s","workflow_run":"%s","workflow_url":"https://github.com/%s/actions/runs/%s","note":"PDFs were generated successfully but webhook notification failed"}' \
            "$ERROR_MSG_ESC" "$REPO_ESC" "$BRANCH_ESC" "$COMMIT_ESC" "$RUN_ID_ESC" "$REPO_ESC" "$RUN_ID_ESC")
          
          # Try to send error notification about webhook failure
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            -f -s -w "\nHTTP Status: %{http_code}\n" || echo "Warning: Failed to send webhook error notification"

      - name: Send error webhook on failure
        if: failure()
        env:
          ERROR_MSG: ${{ env.ERROR_MSG }}
        run: |
          WEBHOOK_URL="https://aeravath.app.n8n.cloud/webhook-test/b88c72d3-7fc3-43ea-ba66-048ab0fb405b"
          
          # Get the failed step name (try to get from job context)
          FAILED_STEP="${GITHUB_ACTION:-Unknown step}"
          
          # Get error message or use default
          ERROR_MESSAGE="${ERROR_MSG:-PDF generation workflow failed}"
          
          # Get commit info
          COMMIT_SHA="${GITHUB_SHA}"
          COMMIT_MSG=$(git log -1 --pretty=%B 2>/dev/null | head -c 200 || echo "Unable to get commit message")
          
          # Get list of .tex files that were supposed to be processed
          TEX_FILES=""
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            TEX_FILES=$(git diff --name-only --diff-filter=ACMR ${{ github.event.before }} ${{ github.sha }} | grep '\.tex$' | tr '\n' ',' | sed 's/,$//' || echo "Unable to determine")
          else
            TEX_FILES=$(git ls-tree -r --name-only HEAD | grep '\.tex$' | tr '\n' ',' | sed 's/,$//' || echo "Unable to determine")
          fi
          
          # Escape JSON strings
          escape_json() {
            echo "$1" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed 's/$/\\n/' | tr -d '\n' | sed 's/\\n$//'
          }
          
          ERROR_MSG_ESC=$(escape_json "$ERROR_MESSAGE")
          COMMIT_MSG_ESC=$(escape_json "$COMMIT_MSG")
          FAILED_STEP_ESC=$(escape_json "$FAILED_STEP")
          TEX_FILES_ESC=$(escape_json "$TEX_FILES")
          REPO_ESC=$(escape_json "${GITHUB_REPOSITORY}")
          BRANCH_ESC=$(escape_json "${GITHUB_REF#refs/heads/}")
          COMMIT_SHA_ESC=$(escape_json "${COMMIT_SHA}")
          RUN_ID_ESC=$(escape_json "${GITHUB_RUN_ID}")
          
          echo "Sending error webhook"
          echo "Error: $ERROR_MESSAGE"
          echo "Failed step: $FAILED_STEP"
          echo "Repository: ${GITHUB_REPOSITORY}"
          echo "Commit: ${COMMIT_SHA}"
          echo "Tex files: $TEX_FILES"
          
          # Build JSON payload using printf
          JSON_PAYLOAD=$(printf '{"status":"error","error_message":"%s","failed_step":"%s","repository":"%s","branch":"%s","commit":"%s","commit_message":"%s","tex_files":"%s","workflow_run":"%s","workflow_url":"https://github.com/%s/actions/runs/%s"}' \
            "$ERROR_MSG_ESC" "$FAILED_STEP_ESC" "$REPO_ESC" "$BRANCH_ESC" "$COMMIT_SHA_ESC" "$COMMIT_MSG_ESC" "$TEX_FILES_ESC" "$RUN_ID_ESC" "$REPO_ESC" "$RUN_ID_ESC")
          
          # Send error webhook (don't fail if webhook call fails)
          if ! curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            -f -s -w "\nHTTP Status: %{http_code}\n"; then
            echo "Warning: Failed to send error webhook (this is not a workflow failure)"
          fi
