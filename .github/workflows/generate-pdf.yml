name: Generate PDF

# n8n will commit the tex file to the repository
# workflow gets triggered
# pdf is generated and saved with the same name in the generated-test branch

on:
  push:
    branches:
      - 'n8n'  # Triggers on push to any branch

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Tectonic
        run: |
          curl --proto '=https' --tlsv1.2 -fsSL https://drop-sh.fullyjustified.net | sh

      - name: Find changed .tex file and build PDF
        id: process_tex
        run: |
          set -e  # Exit on error
          
          # Get the first .tex file that was changed/added in this commit
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            TEX_FILE=$(git diff --name-only --diff-filter=ACMR ${{ github.event.before }} ${{ github.sha }} | grep '\.tex$' | head -n 1 || true)
          else
            # First commit - check all .tex files in HEAD and get the first one
            TEX_FILE=$(git ls-tree -r --name-only HEAD | grep '\.tex$' | head -n 1 || true)
          fi
          
          if [ -z "$TEX_FILE" ]; then
            ERROR_MSG="No .tex file found in this commit"
            echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
            echo "$ERROR_MSG"
            exit 1
          fi
          
          if [ ! -f "$TEX_FILE" ]; then
            ERROR_MSG="Tex file $TEX_FILE not found in repository"
            echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
            echo "$ERROR_MSG"
            exit 1
          fi
          
          echo "Found .tex file: $TEX_FILE"
          echo "Processing $TEX_FILE..."
          
          # Run tectonic and capture errors
          if ! ./tectonic "$TEX_FILE" 2>&1; then
            ERROR_MSG="Failed to process $TEX_FILE with tectonic"
            echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
            echo "$ERROR_MSG"
            exit 1
          fi
          
          # Get the PDF filename (replace .tex with .pdf)
          PDF_FILE="${TEX_FILE%.tex}.pdf"
          
          if [ ! -f "$PDF_FILE" ]; then
            ERROR_MSG="PDF file $PDF_FILE was not created from $TEX_FILE"
            echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
            echo "$ERROR_MSG"
            exit 1
          fi
          
          echo "Successfully generated $PDF_FILE"
          
          # Store file names for later steps
          echo "TEX_FILE=${TEX_FILE}" >> $GITHUB_ENV
          echo "PDF_FILE=${PDF_FILE}" >> $GITHUB_ENV
          echo "PDFS_GENERATED=true" >> $GITHUB_ENV

      - name: Commit and push PDF
        id: commit_push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TEX_FILE: ${{ env.TEX_FILE }}
          PDF_FILE: ${{ env.PDF_FILE }}
        run: |
          set -e  # Exit on error
          
          git config --local user.email "punase.ronak99@gmail.com"
          git config --local user.name "Ronak99"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          
          if [ -z "$PDF_FILE" ] || [ ! -f "$PDF_FILE" ]; then
            ERROR_MSG="PDF file $PDF_FILE not found - PDF may not have been generated"
            echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
            echo "$ERROR_MSG"
            exit 1
          fi
          
          # Store PDF in temporary directory
          mkdir -p /tmp/generated_pdfs
          cp "$PDF_FILE" "/tmp/generated_pdfs/$(basename "$PDF_FILE")"
          echo "Stored $PDF_FILE"
          
          # Fetch all branches
          if ! git fetch origin; then
            ERROR_MSG="Failed to fetch from origin"
            echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
            echo "$ERROR_MSG"
            exit 1
          fi
          
          # Checkout or create the generated-test branch
          if git show-ref --verify --quiet refs/remotes/origin/generated-test; then
            git checkout -b generated-test origin/generated-test 2>/dev/null || git checkout generated-test
            if ! git pull --rebase origin generated-test; then
              ERROR_MSG="Failed to pull/rebase generated-test branch"
              echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
              echo "$ERROR_MSG"
              exit 1
            fi
          else
            git checkout -b generated-test
          fi
          
          # Copy stored PDF to the generated-test branch
          PDF_BASENAME=$(basename "$PDF_FILE")
          if [ -f "/tmp/generated_pdfs/$PDF_BASENAME" ]; then
            cp "/tmp/generated_pdfs/$PDF_BASENAME" "$PDF_FILE"
            git add "$PDF_FILE"
            echo "Added $PDF_FILE to staging"
          else
            ERROR_MSG="PDF file /tmp/generated_pdfs/$PDF_BASENAME not found"
            echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
            echo "$ERROR_MSG"
            exit 1
          fi
          
          # Commit if there are changes
          if ! git diff --staged --quiet; then
            COMMIT_MSG="Auto-generate PDF from $TEX_FILE [skip ci]"
            if ! git commit -m "$COMMIT_MSG"; then
              ERROR_MSG="Failed to commit PDF file"
              echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
              echo "$ERROR_MSG"
              exit 1
            fi
            COMMIT_SHA=$(git rev-parse HEAD)
            if ! git push origin generated-test; then
              ERROR_MSG="Failed to push to generated-test branch"
              echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
              echo "$ERROR_MSG"
              exit 1
            fi
            
            # Store commit SHA for webhook
            echo "COMMIT_SHA=${COMMIT_SHA}" >> $GITHUB_ENV
            echo "PDFS_COMMITTED=true" >> $GITHUB_ENV
          else
            ERROR_MSG="No PDF file to commit - staging area is empty"
            echo "ERROR_MSG=${ERROR_MSG}" >> $GITHUB_ENV
            echo "$ERROR_MSG"
            exit 1
          fi

      - name: Trigger webhook for generated PDF
        if: success() && env.PDFS_COMMITTED == 'true'
        env:
          COMMIT_SHA: ${{ env.COMMIT_SHA }}
          TEX_FILE: ${{ env.TEX_FILE }}
          PDF_FILE: ${{ env.PDF_FILE }}
        run: |
          WEBHOOK_URL="https://aeravath.app.n8n.cloud/webhook-test/b88c72d3-7fc3-43ea-ba66-048ab0fb405b"
          
          if [ -z "$PDF_FILE" ] || [ -z "$TEX_FILE" ]; then
            echo "ERROR: PDF_FILE or TEX_FILE not set"
            exit 1
          fi
          
          # Construct GitHub raw URL for the PDF file
          PDF_URL="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/generated-test/${PDF_FILE}"
          
          echo "Triggering webhook for $TEX_FILE -> $PDF_FILE"
          echo "PDF URL: $PDF_URL"
          
          # Send webhook with PDF URL and handle errors
          # Escape JSON special characters in variables
          PDF_URL_ESC=$(printf '%s' "$PDF_URL" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
          PDF_FILE_ESC=$(printf '%s' "$PDF_FILE" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
          TEX_FILE_ESC=$(printf '%s' "$TEX_FILE" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
          REPO_ESC=$(printf '%s' "$GITHUB_REPOSITORY" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
          COMMIT_ESC=$(printf '%s' "$COMMIT_SHA" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
          
          # Build JSON payload using printf to avoid heredoc issues
          WEBHOOK_PAYLOAD=$(printf '{"status":"success","pdf_url":"%s","pdf_file":"%s","tex_file":"%s","repository":"%s","branch":"generated-test","commit":"%s"}' \
            "$PDF_URL_ESC" "$PDF_FILE_ESC" "$TEX_FILE_ESC" "$REPO_ESC" "$COMMIT_ESC")
          
          if ! curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$WEBHOOK_PAYLOAD" \
            -f -s -w "\nHTTP Status: %{http_code}\n" -o /dev/null; then
            echo "ERROR_MSG=Webhook call failed for $PDF_FILE" >> $GITHUB_ENV
            echo "WEBHOOK_FAILED=true" >> $GITHUB_ENV
            echo "Warning: Failed to send success webhook for $PDF_FILE"
          fi

      - name: Send webhook error notification
        if: success() && env.WEBHOOK_FAILED == 'true'
        env:
          ERROR_MSG: ${{ env.ERROR_MSG }}
          TEX_FILE: ${{ env.TEX_FILE }}
        run: |
          WEBHOOK_URL="https://aeravath.app.n8n.cloud/webhook-test/b88c72d3-7fc3-43ea-ba66-048ab0fb405b"
          
          ERROR_MESSAGE="${ERROR_MSG:-Webhook notification failed after successful PDF generation}"
          TEX_FILE_INFO="${TEX_FILE:-Unable to determine}"
          
          # Escape JSON strings
          escape_json() {
            echo "$1" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed 's/$/\\n/' | tr -d '\n' | sed 's/\\n$//'
          }
          
          ERROR_MSG_ESC=$(escape_json "$ERROR_MESSAGE")
          REPO_ESC=$(escape_json "${GITHUB_REPOSITORY}")
          BRANCH_ESC=$(escape_json "${GITHUB_REF#refs/heads/}")
          COMMIT_ESC=$(escape_json "${GITHUB_SHA}")
          RUN_ID_ESC=$(escape_json "${GITHUB_RUN_ID}")
          TEX_FILE_ESC=$(escape_json "$TEX_FILE_INFO")
          
          # Build JSON payload using printf
          JSON_PAYLOAD=$(printf '{"status":"error","error_message":"%s","error_type":"webhook_failure","repository":"%s","branch":"%s","commit":"%s","tex_file":"%s","workflow_run":"%s","workflow_url":"https://github.com/%s/actions/runs/%s","note":"PDF was generated successfully but webhook notification failed"}' \
            "$ERROR_MSG_ESC" "$REPO_ESC" "$BRANCH_ESC" "$COMMIT_ESC" "$TEX_FILE_ESC" "$RUN_ID_ESC" "$REPO_ESC" "$RUN_ID_ESC")
          
          # Try to send error notification about webhook failure
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            -f -s -w "\nHTTP Status: %{http_code}\n" || echo "Warning: Failed to send webhook error notification"

      - name: Send error webhook on failure
        if: failure()
        env:
          ERROR_MSG: ${{ env.ERROR_MSG }}
        run: |
          WEBHOOK_URL="https://aeravath.app.n8n.cloud/webhook-test/b88c72d3-7fc3-43ea-ba66-048ab0fb405b"
          
          # Get the failed step name (try to get from job context)
          FAILED_STEP="${GITHUB_ACTION:-Unknown step}"
          
          # Get error message or use default
          ERROR_MESSAGE="${ERROR_MSG:-PDF generation workflow failed}"
          
          # Get commit info
          COMMIT_SHA="${GITHUB_SHA}"
          COMMIT_MSG=$(git log -1 --pretty=%B 2>/dev/null | head -c 200 || echo "Unable to get commit message")
          
          # Get the .tex file that was supposed to be processed
          TEX_FILE=""
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            TEX_FILE=$(git diff --name-only --diff-filter=ACMR ${{ github.event.before }} ${{ github.sha }} | grep '\.tex$' | head -n 1 || echo "Unable to determine")
          else
            TEX_FILE=$(git ls-tree -r --name-only HEAD | grep '\.tex$' | head -n 1 || echo "Unable to determine")
          fi
          
          # Escape JSON strings
          escape_json() {
            echo "$1" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed 's/$/\\n/' | tr -d '\n' | sed 's/\\n$//'
          }
          
          ERROR_MSG_ESC=$(escape_json "$ERROR_MESSAGE")
          COMMIT_MSG_ESC=$(escape_json "$COMMIT_MSG")
          FAILED_STEP_ESC=$(escape_json "$FAILED_STEP")
          TEX_FILE_ESC=$(escape_json "$TEX_FILE")
          REPO_ESC=$(escape_json "${GITHUB_REPOSITORY}")
          BRANCH_ESC=$(escape_json "${GITHUB_REF#refs/heads/}")
          COMMIT_SHA_ESC=$(escape_json "${COMMIT_SHA}")
          RUN_ID_ESC=$(escape_json "${GITHUB_RUN_ID}")
          
          echo "Sending error webhook"
          echo "Error: $ERROR_MESSAGE"
          echo "Failed step: $FAILED_STEP"
          echo "Repository: ${GITHUB_REPOSITORY}"
          echo "Commit: ${COMMIT_SHA}"
          echo "Tex file: $TEX_FILE"
          
          # Build JSON payload using printf
          JSON_PAYLOAD=$(printf '{"status":"error","error_message":"%s","failed_step":"%s","repository":"%s","branch":"%s","commit":"%s","commit_message":"%s","tex_file":"%s","workflow_run":"%s","workflow_url":"https://github.com/%s/actions/runs/%s"}' \
            "$ERROR_MSG_ESC" "$FAILED_STEP_ESC" "$REPO_ESC" "$BRANCH_ESC" "$COMMIT_SHA_ESC" "$COMMIT_MSG_ESC" "$TEX_FILE_ESC" "$RUN_ID_ESC" "$REPO_ESC" "$RUN_ID_ESC")
          
          # Send error webhook (don't fail if webhook call fails)
          if ! curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            -f -s -w "\nHTTP Status: %{http_code}\n"; then
            echo "Warning: Failed to send error webhook (this is not a workflow failure)"
          fi
